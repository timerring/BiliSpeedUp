// ==UserScript==
// @name         BiliSpeedUp
// @namespace    https://github.com/timerring/BiliSpeedUp
// @version      1.0.0
// @description  æä¾›Bç«™å¤šå€é€Ÿæ’­æ”¾åŠŸèƒ½ï¼Œæ”¯æŒè‡ªå®šä¹‰è®°å¿†æ’­æ”¾é€Ÿåº¦ã€é¼ æ ‡æ»šè½®è°ƒèŠ‚ã€è§¦æ§æ¿è°ƒèŠ‚
// @author       timerring
// @match        https://www.bilibili.com/video/*
// @match        https://www.bilibili.com/bangumi/play/*
// @grant        none
// @license      MIT
// ==/UserScript==

(function() {
    'use strict';

!function(){"use strict";!function(){const t="bilibili_custom_speed",e=1,n=.07,o=10,i=.01,s=1e3,l=30,r="1.0.0",a=.1,c=.02,p=30,u=50,d="video",h=".bpx-player-ctrl-btn.bpx-player-ctrl-playbackrate",m=".bpx-player-ctrl-playbackrate-menu",b=".bpx-player-ctrl-playbackrate-result",y=".bpx-player-ctrl-playbackrate-menu-item",x="#custom-speed-input",f=".custom-speed-item";function g(){try{const n=localStorage.getItem(t);return n?parseFloat(n):e}catch(t){return console.error("è·å–ä¿å­˜çš„å€é€Ÿå¤±è´¥:",t),e}}function v(e){const n=document.querySelector(d);n&&(n.playbackRate=e,function(e){try{localStorage.setItem(t,e.toString())}catch(t){console.error("ä¿å­˜å€é€Ÿå¤±è´¥:",t)}}(e),k(e))}function k(t){const e=document.querySelector(b);e&&(e.textContent=1===t?"å€é€Ÿ":`${t.toFixed(2)}x`);document.querySelectorAll(y).forEach(e=>{const n=parseFloat(e.getAttribute("data-value"));Math.abs(n-t)<.001?e.classList.add("bpx-state-active"):e.classList.remove("bpx-state-active")});const n=document.querySelector(x);n&&(n.value=t.toFixed(2))}function w(){const t=g();if(t!==e){const e=document.querySelector(d);e&&(e.playbackRate=t,k(t),console.log(`å·²åº”ç”¨ä¿å­˜çš„å€é€Ÿ: ${t}x`))}}function S(t){return Math.max(n,Math.min(o,t))}function q(){const t=document.createElement("li");t.className="bpx-player-ctrl-playbackrate-menu-item custom-speed-item",t.style.cssText="\n        padding: 8px 10px;\n        cursor: default;\n        background: transparent;\n        margin-top: 0;\n        border-top: none;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n    ";const s=document.createElement("div");s.style.cssText="display: flex; flex-direction: column; gap: 6px;";const l=document.createElement("div");l.style.cssText="display: flex; align-items: center; gap: 6px; justify-content: center;";const r=function(){const t=document.createElement("input");t.type="number",t.id="custom-speed-input",t.min=n,t.max=o,t.step=i,t.value=g().toFixed(2),t.style.cssText="\n        width: 52px;\n        padding: 4px 6px;\n        border: 1px solid #3a3a3a;\n        border-radius: 4px;\n        font-size: 14px;\n        text-align: center;\n        color: #fff;\n        background: #212121;\n        appearance: textfield;\n        -moz-appearance: textfield;\n        -webkit-appearance: none;\n    ",t.onmouseover=()=>{t.style.background="#3a3a3a"},t.onmouseout=()=>{t.style.background="#212121"};const s=()=>{let n=parseFloat(t.value);isNaN(n)&&(n=e),n=S(n),t.value=n.toFixed(2),v(n)};return t.onkeypress=t=>{"Enter"===t.key&&(t.stopPropagation(),s())},t.onblur=s,t}();return l.appendChild(r),s.appendChild(l),t.appendChild(s),t.onclick=t=>{t.stopPropagation()},t}function E(t){return t>0?1:-1}function T(){const t=document.querySelector(h);if(!t||t.dataset.customWheelBound)return;t.dataset.customWheelBound="true";let n=0;t.addEventListener("wheel",t=>{t.preventDefault(),t.stopPropagation();const o=document.querySelector(d);if(!o)return;let i=o.playbackRate||e;var s;if(0===(s=t).deltaMode&&Math.abs(s.deltaY)<u){if(n+=t.deltaY,Math.abs(n)<p)return;const e=E(n);n-=e*p,i+=e*c,i=Math.round(50*i)/50}else{i-=E(t.deltaY)*a,i=Math.round(10*i)/10}i=S(i),v(i)},{passive:!1})}class ${constructor(){this.steps=[],this.currentStep=0,this.overlay=null,this.tooltip=null,this.highlight=null}start(){(function(t){const e=`bilibili_speed_tour_shown_v${t}`;return!!localStorage.getItem(e)})(r)||(this.initStyles(),this.createOverlay(),this.createTooltip(),this.defineSteps(),setTimeout(()=>this.showStep(0),1e3))}initStyles(){const t=function(t){const e=document.createElement("style");return e.textContent=t,e}("\n        .tour-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); z-index: 99999; pointer-events: none; transition: opacity 0.3s; }\n        .tour-highlight { position: absolute; box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.6); z-index: 99998; border-radius: 4px; pointer-events: none; transition: all 0.3s ease; border: 2px solid #00aeec; }\n        .tour-tooltip { position: absolute; background: #212121; color: #fff; padding: 16px; border-radius: 8px; width: 280px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); z-index: 100000; font-size: 14px; line-height: 1.6; border: 1px solid #3a3a3a; transition: all 0.3s ease; pointer-events: none; }\n        .tour-tooltip h3 { margin: 0 0 8px 0; color: #00aeec; font-size: 16px; font-weight: bold; }\n        .tour-tooltip p { margin: 0 0 16px 0; color: #e0e0e0; }\n        .tour-footer { display: flex; justify-content: flex-end; gap: 10px; pointer-events: auto; }\n        .tour-btn { padding: 6px 12px; border-radius: 4px; cursor: pointer; border: none; font-size: 12px; transition: background 0.2s; pointer-events: auto; }\n        .tour-btn-skip { background: transparent; color: #999; }\n        .tour-btn-skip:hover { color: #ccc; }\n        .tour-btn-next { background: #00aeec; color: #fff; }\n        .tour-btn-next:hover { background: #008bbd; }\n\n        /* åŠ¨ç”»æ ·å¼ */\n        .anim-container { display: flex; gap: 20px; margin-bottom: 15px; justify-content: center; }\n        .anim-box { display: flex; flex-direction: column; align-items: center; gap: 8px; }\n        .anim-label { font-size: 12px; color: #999; }\n        \n        /* é¼ æ ‡å›¾æ ‡ */\n        .anim-mouse {\n            width: 24px; height: 38px;\n            border: 2px solid #fff; border-radius: 12px;\n            position: relative;\n        }\n        .anim-scroll {\n            width: 4px; height: 6px; background: #00aeec;\n            border-radius: 2px; position: absolute;\n            left: 50%; transform: translateX(-50%);\n            top: 6px;\n            animation: scroll-wheel 1.5s infinite;\n        }\n        @keyframes scroll-wheel {\n            0% { top: 6px; opacity: 1; }\n            100% { top: 20px; opacity: 0; }\n        }\n\n        /* è§¦æ§æ¿å›¾æ ‡ */\n        .anim-touchpad {\n            width: 38px; height: 38px;\n            border: 2px solid #fff; border-radius: 4px;\n            position: relative; overflow: hidden;\n        }\n        .anim-finger {\n            width: 8px; height: 8px; background: #00aeec;\n            border-radius: 50%; position: absolute;\n            left: 50%; top: 60%;\n            transform: translate(-50%, -50%);\n            animation: scroll-touch 1.5s infinite;\n            box-shadow: 0 0 0 4px rgba(0, 174, 236, 0.3);\n        }\n        @keyframes scroll-touch {\n            0% { top: 70%; opacity: 0; }\n            20% { top: 70%; opacity: 1; }\n            80% { top: 30%; opacity: 1; }\n            100% { top: 30%; opacity: 0; }\n        }\n\n        /* å¼ºåˆ¶æ˜¾ç¤ºèœå•æ ·å¼ */\n        .tour-force-show {\n            display: block !important;\n            visibility: visible !important;\n            opacity: 1 !important;\n        }\n    ");document.head.appendChild(t)}createOverlay(){this.highlight=document.createElement("div"),this.highlight.className="tour-highlight",document.body.appendChild(this.highlight)}createTooltip(){this.tooltip=document.createElement("div"),this.tooltip.className="tour-tooltip",document.body.appendChild(this.tooltip)}defineSteps(){this.steps=[{element:h,title:"å€é€Ÿæ§åˆ¶å¢å¼º",content:"ğŸ‘‹ æ¬¢è¿ä½¿ç”¨å€é€Ÿå¢å¼ºè„šæœ¬ï¼<br>è¿™é‡Œæ˜¯å€é€Ÿæ§åˆ¶å…¥å£ï¼Œæ”¯æŒæ‚¬åœæŸ¥çœ‹èœå•ã€‚",position:"top"},{element:x,title:"è‡ªå®šä¹‰å€é€Ÿ",content:"ğŸ”¢ åœ¨è¿™é‡Œç›´æ¥è¾“å…¥ä»»æ„å€é€Ÿ (0.07 - 10.0)ã€‚<br>æ”¯æŒ 0.01 ç²¾åº¦ï¼Œè¾“å…¥åå›è½¦å³å¯åº”ç”¨ã€‚",position:"right",action:()=>{const t=document.querySelector(m);t&&(t.style.display="block",t.style.visibility="visible",t.style.opacity="1");const e=document.querySelector(x);e&&e.focus()}},{element:m,title:"æ»šè½®ä¸è§¦æ§æ¿è°ƒèŠ‚",content:'\n                    <div class="anim-container">\n                        <div class="anim-box">\n                            <div class="anim-mouse"><div class="anim-scroll"></div></div>\n                            <span class="anim-label">é¼ æ ‡æ»šè½®</span>\n                        </div>\n                        <div class="anim-box">\n                            <div class="anim-touchpad"><div class="anim-finger"></div></div>\n                            <span class="anim-label">è§¦æ§æ¿æ»‘åŠ¨</span>\n                        </div>\n                    </div>\n                    ä¸Šæ»‘/æ»šåŠ¨å¢åŠ å€é€Ÿï¼Œä¸‹æ»‘/æ»šåŠ¨å‡å°‘å€é€Ÿã€‚<br><br>\n                    ğŸ–±ï¸ <b>é¼ æ ‡æ»šè½®ï¼š</b>åœ¨æŒ‰é’®æˆ–èœå•ä¸Šæ»šåŠ¨ï¼Œå¿«é€Ÿè°ƒèŠ‚ (Â±0.1)ã€‚<br>\n                    ğŸ‘† <b>è§¦æ§æ¿ï¼š</b>åœ¨æŒ‰é’®æˆ–èœå•ä¸Šä¸Šä¸‹æ»‘åŠ¨ï¼Œç»†è…»å¾®è°ƒ (Â±0.02)ã€‚<br>\n                    ğŸ’¾ <b>è‡ªåŠ¨è®°å¿†ï¼š</b>æ‚¨çš„å€é€Ÿè®¾ç½®ä¼šè‡ªåŠ¨ä¿å­˜ï¼Œä¸‹æ¬¡è§‚çœ‹è‡ªåŠ¨æ¢å¤ã€‚\n                ',position:"left",action:()=>{const t=document.querySelector(m);t&&(t.style.display="block",t.style.visibility="visible",t.style.opacity="1")},isLast:!0}]}showStep(t){if(t>=this.steps.length)return void this.end();this.currentStep=t;const e=this.steps[t];e.action&&e.action();let n=e.element;if("string"==typeof n&&(n=document.querySelector(n)),n||e.isLast){if(e.element===m||e.element===x){const t=document.querySelector(m);t&&(t.style.display="block !important",t.style.visibility="visible !important",t.style.opacity="1 !important",t.classList.add("tour-force-show"))}if("center"===e.position)this.highlight.style.display="none",this.tooltip.style.top="50%",this.tooltip.style.left="50%",this.tooltip.style.transform="translate(-50%, -50%)";else{const t=n.getBoundingClientRect(),o=window.scrollY,i=window.scrollX;this.highlight.style.display="block",this.highlight.style.width=`${t.width}px`,this.highlight.style.height=`${t.height}px`,this.highlight.style.top=`${t.top+o}px`,this.highlight.style.left=`${t.left+i}px`,this.positionTooltip(e.position,t,o,i)}this.renderTooltip(e)}else this.showStep(t+1)}positionTooltip(t,e,n,o){"top"===t?(this.tooltip.style.top=e.top+n-160+"px",this.tooltip.style.left=e.left+o-100+"px",this.tooltip.style.transform="none"):"right"===t?(this.tooltip.style.top=`${e.top+n}px`,this.tooltip.style.left=`${e.right+o+20}px`,this.tooltip.style.transform="none"):"left"===t&&(this.tooltip.style.top=`${e.top+n}px`,this.tooltip.style.left=e.left+o-320+"px",this.tooltip.style.transform="none")}renderTooltip(t){this.tooltip.innerHTML=`\n            <h3>${t.title}</h3>\n            <p>${t.content}</p>\n            <div class="tour-footer">\n                <button class="tour-btn tour-btn-skip" id="tour-skip">è·³è¿‡</button>\n                <button class="tour-btn tour-btn-next" id="tour-next">\n                    ${t.isLast?"å®Œæˆ":"ä¸‹ä¸€æ­¥"}\n                </button>\n            </div>\n        `,document.getElementById("tour-next").onclick=()=>this.showStep(this.currentStep+1),document.getElementById("tour-skip").onclick=()=>this.end()}end(){this.highlight&&this.highlight.remove(),this.tooltip&&this.tooltip.remove(),function(t){const e=`bilibili_speed_tour_shown_v${t}`;localStorage.setItem(e,"true")}(r);const t=document.querySelector(m);t&&(t.classList.remove("tour-force-show"),t.style.display="",t.style.visibility="",t.style.opacity="");const e=document.querySelector(h);e&&e.dispatchEvent(new MouseEvent("mouseout"))}}function B(){let t=0;const e=setInterval(()=>{t++,function(){const t=document.querySelector(m);if(!t)return!1;if(t.querySelector(f))return!0;const e=q(),n=t.querySelector('.bpx-player-ctrl-playbackrate-menu-item[data-value="2"]'),o=t.querySelector(".bpx-player-ctrl-playbackrate-menu-item:not(.custom-speed-item)");return n?t.insertBefore(e,n):o?t.insertBefore(e,o):t.appendChild(e),t.querySelectorAll(".bpx-player-ctrl-playbackrate-menu-item:not(.custom-speed-item)").forEach(t=>{t.addEventListener("click",()=>{v(parseFloat(t.getAttribute("data-value")))})}),T(),console.log("Bç«™å€é€Ÿå¢å¼ºå·²åŠ è½½"),!0}()&&(setTimeout(w,500),setTimeout(()=>(new $).start(),1500),clearInterval(e),function(){const t=new MutationObserver(()=>{w()}),e=document.querySelector(d);e&&e.parentElement&&t.observe(e.parentElement,{childList:!0,subtree:!0})}()),t>=l&&(clearInterval(e),console.warn("Bç«™å€é€Ÿå¢å¼ºåŠ è½½å¤±è´¥ï¼šæœªæ‰¾åˆ°æ’­æ”¾å™¨æ§åˆ¶å…ƒç´ "))},s)}location.hostname.includes("bilibili.com")&&(location.pathname.includes("/video/")||location.pathname.includes("/bangumi/play/"))?(console.log("å¼€å§‹åŠ è½½ Bç«™å€é€Ÿå¢å¼º..."),B()):console.warn("è¯·åœ¨ Bç«™è§†é¢‘é¡µé¢è¿è¡Œæ­¤è„šæœ¬")}()}();
